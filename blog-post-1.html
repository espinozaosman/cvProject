<!DOCTYPE html>
<html lang="en" class="no-js">
  
<!-- Mirrored from lmpixels.com/demo/procard/blog-post-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Aug 2021 23:55:36 GMT -->
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> 
    <title>Julian Kosmalski Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="PRO Card - Material Resume / CV / vCard Template" />
    <meta name="keywords" content="vcard, resposnive, retina, resume, jquery, css3, bootstrap, Material CV, portfolio" />
    <meta name="author" content="lmtheme" />
    <link rel="shortcut icon" href="favicon.ico">

    <link rel="stylesheet" href="css/bootstrap.css" type="text/css">
    <link rel="stylesheet" href="css/normalize.css" type="text/css">
    <link rel="stylesheet" href="css/animate.css" type="text/css">
    <link rel="stylesheet" href="css/transition-animations.css" type="text/css">
    <link rel="stylesheet" href="css/owl.carousel.css" type="text/css">
    <link rel="stylesheet" href="css/magnific-popup.css" type="text/css">
    <link rel="stylesheet" href="css/main-green.css" type="text/css">

    <!-- This styles needs for demo -->
    <link rel="stylesheet" href="preview/lmpixels-demo-panel.css" type="text/css">
    <!-- /This styles needs for demo -->

    <script src="js/jquery-2.1.3.min.js"></script>
    <script src="js/modernizr.custom.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','../../../www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-101372703-1', 'auto');
      ga('send', 'pageview');
    
    </script>
    <script src='../../../www.google.com/recaptcha/api.js'></script>
  <script async src='../../cdn-cgi/bm/cv/669835187/api.js'></script></head>

  <body class="material-template">
    <!-- Loading animation -->
    <div class="preloader">
      <div class="preloader-animation">
        <div class="preloader-spinner">
        </div>
      </div>
    </div>
    <!-- /Loading animation -->

    <div id="page" class="page">
      <!-- Header -->
      <header id="site_header" class="header mobile-menu-hide">
        <div class="header-content">
          <div class="site-title-block mobile-hidden">
            <div class="site-title">Julian <span>Kosmalski</span></div>
          </div>

          <!-- Navigation -->
          <div class="site-nav">
            <!-- Main menu -->
            <ul id="nav" class="site-main-menu">
              <li>
                <a class="pt-trigger" href="index.html#home" data-animation="62">Home</a><!-- href value = data-id without # of .pt-page. -->
              </li>
              <li>
                <a class="pt-trigger" href="index.html#resume" data-animation="62">Resume</a>
              </li>
              <li>
                <a class="pt-trigger" href="index.html#services" data-animation="62">Services</a>
              </li>
              <li>
                <a class="pt-trigger" href="index.html#portfolio" data-animation="62">Portfolio</a>
              </li>
              <li class="active">
                <a class="pt-trigger" href="index.html#blog" data-animation="62">Blog</a>
              </li>
              <li>
                <a class="pt-trigger" href="index.html#contact" data-animation="62">Contact</a>
              </li>
            </ul>
            <!-- /Main menu -->
          </div>
          <!-- Navigation -->
        </div>
      </header>
      <!-- /Header -->

      <!-- Mobile Header -->
      <div class="mobile-header mobile-visible">
        <div class="mobile-logo-container">
          <div class="mobile-site-title">Julian Kosmalski</div>
        </div>

        <a class="menu-toggle mobile-visible">
          <i class="fa fa-bars"></i>
        </a>
      </div>
      <!-- /Mobile Header -->

      <!-- Main Content -->
      <div id="main" class="site-main">
        <!-- Single Page Content -->
        <div class="single-page-content">
          <div class="content-area">
            <div class="page-content">
              <!-- Blog Entry Content -->
              <div class="blog-post-main-image">
                <img class="post-image img-responsive" src="images/blog/blog-img-01.jpeg" alt="blog-post-1" />
              </div>

              <div class="blog-post-content">

                <div class="entry-meta">
                  <span class="date"><a href="#"><i class="fa fa-fw fa-clock-o"></i> 22 March, 2021</a></span>
                  <span class="divider">|</span>
                  <span class="autor"><a href="#"><i class="fa fa-fw fa-user"></i> Julian Kosmalski</a></span>
                  <span class="divider">|</span>
                  <span class="category"><a href="#"><i class="fa fa-fw fa-folder"></i> React</a></span>
                </div>

                <h1>React and Graphql Optimization Story</h1>
                <p>While doing some work on the Product Hunt stories page, I noticed that the page was performing too many SQL queries. The page itself is quite simple.</p>

                <div class="content-area">
                  <img class="post-image img-responsive" src="images/blog/refactoring_story_index.png" alt="blog-post-img-1" />
                </div> 
                <br>

                <p>The following is the React structure of the page:</p>

              <pre>
                <code class="language-jsx">
                &lt;Header&gt;
                  &lt;Flex.Row&gt;
                    &lt;Image&gt;
                    &lt;Flex.Column&gt;
                      &lt;Title /&gt;
                      &lt;Meta /&gt;
                      &lt;Tagline /&gt;
                      &lt;StoryVoteButton showVoters={true} /&gt;
                    &lt;/Flex.Column&gt;
                  &lt;/Flex.Row&gt;
                &lt;/Header&gt;
                &lt;Layout&gt;
                  &lt;Layout.Content&gt;
                    &lt;StoryItem&gt;
                      &lt;Flex.Row&gt;
                        &lt;Flex.Column&gt;
                          &lt;Title /&gt;
                          &lt;Meta /&gt;
                          &lt;StoryVoteButton showVoters={false} /&gt;
                          &lt;Tagline /&gt;
                        &lt;/Flex.Column&gt;
                        &lt;Image&gt;
                      &lt;/Flex.Row&gt;
                    &lt;/StoryItem&gt;
                  &lt;/Layout.Content&gt;
                  &lt;Layout.Sidebar /&gt;
                &lt;/Layout&gt;
                </code>
              </pre>
                
              

              <p>For the page we have the following GraphQL query:</p>

              <pre><code class="language-graphql">
                #import &quot;~/components/StoryHero/Fragment.graphql&quot;
                #import &quot;~/components/StoryItem/Fragment.graphql&quot;
                
                query StoriesIndexPage($cursor: String) {
                  heroStory: stories(first: 1) {
                    edges {
                      node {
                        id
                        ...StoryHeroFragment
                      }
                    }
                  }
                
                  stories(first: 8, after: $cursor) {
                    edges {
                      node {
                        id
                        ...StoryItemFragment
                      }
                    }
                    pageInfo {
                      endCursor
                      hasNextPage
                    }
                  }
                }
                </code>
              </pre>

              <p>After some debugging, I figure out the issue is the <code>StoryVoteButton</code>. It was making N+1 queries to load the voters of story items.</p>
              <p>The vote button was using the following GraphQL Fragment</p>
              
              <pre><code class="language-graphql"># FILE: ~/components/StoryVoteButton/Fragment.graphql
                #import &quot;~/components/UserImage/Fragment.graphql&quot;
                
                fragment StoryVoteButtonFragment on Story {
                  id
                  hasVoted
                  votesCount
                  voters(first: 6) {
                    edges {
                      node {
                        id
                        ...UserImage
                      }
                    }
                  }
                }
                </code></pre>
                <p>Notice that it loads the voters of the story. It is quite expensive, because:</p>
                <ul>
                <li>the connection edge doesn't batch load voters due to pagination</li>
                <li>the voters query is expensive due to complex order conditions like showing current user friends first, then popular users, and so.</li>
                </ul>
                <p>The button had two variants with and without voters:</p>
                <img src="https://rstankov-blog.s3.amazonaws.com/refactoring_story_vote_with_voters.png" alt="Vote button with voters" />
                <img src="https://rstankov-blog.s3.amazonaws.com/refactoring_story_vote.png" alt="Vote botton without voters" />
                <p>Showing voters was controlled by a prop named <code>showVoters</code>:</p>
                <pre><code class="language-jsx">&lt;StoryVoteButton story={story} showVoters={true} /&gt;
                &lt;StoryVoteButton story={story} showVoters={false} /&gt;
                </code></pre>
                <p>When <code>showVoters</code> is false, we don't need <code>voters</code>. However, we still load them. We only need them once on a page, so we over-fetch most of the time.</p>
                <h2 id="fix1">Fix 1</h2>
                <p>My first fix took me just 15 minutes.</p>
                <p>I just created a second fragment, <code>FragmentWithVoters.graphql</code>, and let the component consumers use it when they pass <code>showVoters={true}</code>. This fragment included the voters.</p>
                <pre><code class="language-graphql"># FILE: &quot;~/components/StoryVoteButton/Fragment.graphql&quot;
                fragment StoryVoteButtonFragment on Story {
                  id
                  hasVoted
                  votesCount
                }
                </code></pre>
                <pre><code class="language-graphql"># FILE: &quot;~/components/StoryVoteButton/FragmentWithVoters.graphql&quot;
                #import &quot;~/components/StoryVoteButton/Fragment.graphql&quot;
                #import &quot;~/components/UserImage/Fragment.graphql&quot;
                
                fragment StoryVoteButtonWithVotersFragment on Story {
                  id
                  voters(first: 6) {
                    edges {
                      node {
                        id
                        ...UserImage
                      }
                    }
                  }
                  ...StoryVoteButtonFragment
                }
                </code></pre>
                <p>It was nice and easy.</p>
                <p>Job well done ...  ðŸ’ª</p>
                <p>...then, while I was doing a self-code-review, I realized that this makes the code more complex.</p>
                <p>The consumer has to know that a property requires a particular fragment and use it instead of the default one. This distinction isn't obvious. ðŸ¤”</p>
                <p>Those thoughts helped me realize and I had broken this button on the stories show page. ðŸ™ˆ</p>
                <h2 id="fix2">Fix 2</h2>
                <p>I moved my pull request into a &quot;work in progress&quot; state and started refactoring.</p>
                <p>I decided to split <code>StoryVoteButton</code> into:</p>
                <ol>
                <li><code>StoryVoteButton</code> - loads only counters</li>
                </ol>
                <img src="https://rstankov-blog.s3.amazonaws.com/refactoring_story_vote.png" alt="Vote botton without voters" />
                <ol start="2">
                <li><code>StoryVoteButtonWithVoters</code> - <code>StoryVoteButton</code> + story voters</li>
                </ol>
                <img src="https://rstankov-blog.s3.amazonaws.com/refactoring_story_vote_with_voters.png" alt="Vote button with voters" />
                <h2 id="conclusion">Conclusion</h2>
                <p>Moral of the story: Alway do a self-code-review as if you didn't write this code ðŸ˜‡</p>
                <p>Secondary learning is that in React, sometimes props are just hidden components, and we shouldn't push too much logic in a single component. Better to have two components. ðŸŽ©</p>
                </div>               

        

                <div class="entry-meta entry-tags-share">
                  <!-- Share Buttons -->
                  <div class="btn-group share-buttons pull-right hidden-xs">
                    <a href="#" target="_blank" class="btn"><i class="fa fa-facebook"></i> </a>
                    <a href="#" target="_blank" class="btn"><i class="fa fa-twitter"></i> </a>
                    <a href="#" target="_blank" class="btn"><i class="fa fa-dribbble"></i> </a>
                  </div>
                  <!-- /Share Buttons -->
                  <ul class="tags">
                    <li><a>React</a></li>
                  </ul>
                </div>                  
              </div>
              <!-- End of Blog Entry Content -->
            </div>
          </div>
        </div>
        <!-- End of Single Page Content -->
      </div>
      <!-- /Main Content -->
    </div>
    <footer>
      <div class="copyrights">Â© 2017 All rights reserved. Material template by LMPixels</div>
    </footer>

    
    <script type="text/javascript" src="js/bootstrap.min.js"></script>
    <script type="text/javascript" src="js/pages-switcher.js"></script>
    <script type="text/javascript" src="js/imagesloaded.pkgd.min.js"></script>
    <script type="text/javascript" src="js/validator.js"></script>
    <script type="text/javascript" src="js/jquery.shuffle.min.js"></script>
    <script type="text/javascript" src="js/masonry.pkgd.min.js"></script>
    <script type="text/javascript" src="js/owl.carousel.min.js"></script>
    <script type="text/javascript" src="js/jquery.magnific-popup.min.js"></script>
    <script type="text/javascript" src="js/jquery.hoverdir.js"></script>
    <!--<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=YOUR-API-KEY"></script>-->
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
    <script type="text/javascript" src="js/jquery.googlemap.js"></script>
    <script type="text/javascript" src="js/main.js"></script>

    <!-- Demo Color changer Script -->
    <script src="preview/lmpixels-demo-panel.js"></script>
    <!-- /Demo Color changer Script -->
  <script type="text/javascript">(function(){window['__CF$cv$params']={r:'67e5dfc04e050d30',m:'9fdf944ad0bded2196b688e3eadfaf1ceb2d19cb-1628898923-1800-AfTRKn4y8U/EGfh938vYm8bT8BD+pewxd86cI7fFeHUaDrI2M38MuWdauuZq4T2Fq4GcDZF9J8s0rTtgo4ntqmkC55fQeaUB+FS8CoyhO8G27K09F58ZUAMTdzd7razDTvIPR+8ZwI7PMhRquvSTEvY=',s:[0xf056b21fd8,0xa5e02a3abb],}})();</script><script defer src="../../../static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"rayId":"67e5dfc04e050d30","version":"2021.8.0","r":1,"token":"94b99c0576dc45bf9d669fb5e9256829","si":10}'></script>
</body>

<!-- Mirrored from lmpixels.com/demo/procard/blog-post-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 13 Aug 2021 23:55:38 GMT -->
</html>
